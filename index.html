<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hearthstone Combo Trainer</title>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #2c2f33;
            color: #ffffff;
            margin: 0;
            padding: 20px;
        }

        h1, h2 {
            color: #f0b90b; /* ‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡πÅ‡∏ö‡∏ö Hearthstone */
            border-bottom: 2px solid #f0b90b;
            padding-bottom: 10px;
        }
        
        h2 .card-counter {
            color: #99aab5;
            font-weight: normal;
            font-size: 0.8em;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #23272a;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        /* --- ‡∏´‡∏ô‡πâ‡∏≤ 1: Setup --- */
        #setup-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card-selection {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .card-control {
            background-color: #3b3f44;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border: 1px solid #4f545c;
        }

        .card-control img {
            width: 100%;
            max-width: 180px;
            border-radius: 8px;
            border: 2px solid #1c1e21;
        }

        .card-control label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .card-control .card-note {
            font-size: 0.85em;
            color: #99aab5;
            margin-top: 5px;
            font-style: italic;
        }

        .card-control input,
        .card-control select {
            width: 90%;
            padding: 8px;
            margin-top: 5px;
            border-radius: 4px;
            border: 1px solid #7289da;
            background-color: #2c2f33;
            color: white;
            font-size: 1em; 
        }

        .pupil-options {
            font-size: 0.9em;
            margin-top: 10px;
        }

        .mana-setup { 
            margin-top: 20px;
            background-color: #3b3f44;
            padding: 15px;
            border-radius: 5px;
        }
        
        #start-mana {
             width: 100px; 
        }

        #start-button, #recommend-button, #show-guide-button, #back-to-setup-button {
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            padding: 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        #start-button {
            background-color: #4caf50; 
            margin-top: 20px;
        }
        #start-button:hover {
            background-color: #45a049;
        }

        #recommend-button {
            background-color: #7289da; 
            margin-bottom: 20px;
        }
        #recommend-button:hover {
            background-color: #5f73bc;
        }
        
        #show-guide-button, #back-to-setup-button {
             background-color: #f39c12; /* ‡∏™‡∏µ‡∏™‡πâ‡∏° */
             margin-top: 10px;
        }
        #show-guide-button:hover, #back-to-setup-button:hover {
             background-color: #d35400;
        }


        /* --- ‡∏´‡∏ô‡πâ‡∏≤ 2: Trainer --- */
        #stats-bar {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap; 
            background-color: #1c1e21;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        .stat {
            text-align: center;
            min-width: 100px; 
        }

        .stat-label {
            font-size: 0.8em;
            color: #99aab5;
        }

        .stat-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #f0b90b;
        }
        
        #prompt-message {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #f0b90b;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #3b3f44;
            border-radius: 5px;
        }
        
        /* [*** CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Rope ***] */
        #rope-container {
            display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô */
            width: 100%;
            height: 10px;
            background: linear-gradient(to right, #c0392b 50%, #5a3c20 50%); /* ‡πÅ‡∏î‡∏á / ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• */
            background-size: 200% 100%;
            animation: burn-rope 20s linear forwards;
            border: 2px solid #3d2815;
            margin: 20px 0; /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞ */
        }
        @keyframes burn-rope {
            from { background-position: 100% 0; } /* ‡πÄ‡∏£‡∏¥‡πà‡∏°: ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
            to { background-position: 0% 0; }   /* ‡∏à‡∏ö: ‡πÅ‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
        }
        /* [*** ‡∏à‡∏ö CSS Rope ***] */


        #board, #hand {
            min-height: 220px;
            background-color: #3b3f44;
            border: 2px dashed #4f545c;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: flex-start;
        }

        .card-in-hand {
            position: relative;
            width: 140px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            background-color: #23272a;
            border-radius: 10px;
            border: 2px solid #1c1e21;
            overflow: hidden;
        }

        .card-in-hand img {
            width: 100%;
            display: block;
        }

        .card-cost {
            position: absolute;
            top: -5px;
            left: -5px;
            background-color: #4a90e2; 
            color: white; 
            font-weight: bold;
            font-size: 1.5em;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid white;
            text-shadow: 1px 1px 2px black;
        }

        .pupil-counter {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background-color: #c0392b; 
            color: white;
            font-weight: bold;
            font-size: 0.9em;
            padding: 3px 6px;
            border-radius: 4px;
            border: 1px solid white;
        }

        .card-in-hand:hover {
            transform: translateY(-10px);
            box-shadow: 0 10px 20px rgba(240, 185, 11, 0.4);
        }

        .card-in-hand.unplayable {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #c0392b;
        }

        .card-in-hand.unplayable:hover {
            transform: none;
            box-shadow: none;
        }

        .minion-on-board {
            width: 120px;
            background-color: #2c2f33;
            border: 2px solid #4caf50; 
            border-radius: 8px;
            padding: 5px;
            text-align: center;
        }

        .minion-on-board img {
            width: 100%;
            border-radius: 4px;
        }

        .minion-on-board p {
            margin: 5px 0 0 0;
            font-weight: bold;
            font-size: 0.9em;
        }

        .minion-on-board.targeting {
            cursor: pointer;
            border-color: #f0b90b;
            box-shadow: 0 0 15px #f0b90b;
        }

        .trainer-buttons {
            display: flex;
            gap: 10px;
        }

        #end-turn-button, #undo-button {
            flex-grow: 1;
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            padding: 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        #end-turn-button {
            background-color: #c0392b; 
        }
        #end-turn-button:hover {
            background-color: #a93226;
        }
        
        #undo-button {
            background-color: #f39c12; 
        }
        #undo-button:hover {
            background-color: #d35400;
        }
        #undo-button:disabled {
            background-color: #5e6063;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* --- Modal (Popup) CSS --- */
        #modal-overlay {
            display: none; 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        #modal-box {
            background-color: #2c2f33;
            padding: 25px;
            border-radius: 8px;
            border: 2px solid #f0b90b;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            
            /* [*** ‡πÄ‡∏û‡∏¥‡πà‡∏°: scrollbar ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô modal ***] */
            max-height: 80vh;
            overflow-y: auto;
        }
        #modal-title {
            margin-top: 0;
            color: #f0b90b;
        }
        #modal-message {
            font-size: 1.1em;
            white-space: pre-wrap; 
        }
        #modal-close-button, #modal-restart-button {
            font-size: 1em;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            margin: 10px 5px 0 5px;
        }
        #modal-close-button {
            background-color: #7289da;
            color: white;
        }
        #modal-restart-button {
            background-color: #4caf50;
            color: white;
        }
        
        .discover-grid {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        .discover-option-card {
            width: 100px;
            cursor: pointer;
            border-radius: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid transparent;
        }
        .discover-option-card:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px #f0b90b;
            border-color: #f0b90b;
        }
        
        .bob-option {
            background-color: #3b3f44;
            border: 1px solid #4f545c;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            width: 100px; 
            transition: background-color 0.2s;
        }
        .bob-option:hover {
            background-color: #4f545c;
        }
        .bob-option img {
            width: 80px;
            border-radius: 5px;
        }
        .bob-option p {
            margin: 5px 0 0 0;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        /* [*** CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Guide ***] */
        #guide-steps {
            text-align: left;
        }
        .guide-step {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            background-color: #3b3f44;
            border-radius: 5px;
            margin-bottom: 10px;
            border: 1px solid #4f545c;
        }
        .guide-step img {
            width: 80px;
            border-radius: 5px;
        }
        .guide-step-text {
            flex: 1;
        }
        .guide-step-text strong {
            color: #f0b90b;
        }
        .guide-loop {
            text-align: center;
            font-weight: bold;
            color: #7289da;
            margin: 20px 0;
            font-style: italic;
        }
        
    </style>
</head>
<body>

    <div id="setup-container" class="container">
        <h1>üõ†Ô∏è ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡πå‡∏î</h1>
        <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏°‡∏≤‡∏ô‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô (‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ 75 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</p>

        <form id="setup-form">
            <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡πÉ‡∏ö)</h2>
            
            <button type="button" id="recommend-button">‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</button>

            <div class="card-selection">
                
                <div class="card-control">
                    <img src="https://hearthstone.wiki.gg/images/thumb/EX1_144.png/300px-EX1_144.png" alt="Shadowstep">
                    <label for="shadowstep">Shadowstep (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 2)</label>
                    <select id="shadowstep" name="shadowstep">
                        <option value="0">0 ‡πÉ‡∏ö</option>
                        <option value="1">1 ‡πÉ‡∏ö</option>
                        <option value="2">2 ‡πÉ‡∏ö</option>
                    </select>
                </div>

                <div class="card-control">
                    <img src="https://hearthstone.wiki.gg/images/thumb/VAC_304.png/300px-VAC_304.png" alt="Tidepool Pupil">
                    <label for="tidepool">Tidepool Pupil (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 2)</label>
                    <select id="tidepool" name="tidepool">
                        <option value="0">0 ‡πÉ‡∏ö</option>
                        <option value="1">1 ‡πÉ‡∏ö</option>
                        <option value="2">2 ‡πÉ‡∏ö</option>
                    </select>
                    <div id="pupil-options-container" style="display: none;">
                        <div class="pupil-options" id="pupil-1-options">
                            <label for="pupil-1-spells">‡πÉ‡∏ö‡∏ó‡∏µ‡πà 1 (‡∏£‡πà‡∏≤‡∏¢‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß):</label>
                            <select id="pupil-1-spells" name="pupil-1-spells">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                            </select>
                        </div>
                        <div class="pupil-options" id="pupil-2-options" style="display: none;">
                            <label for="pupil-2-spells">‡πÉ‡∏ö‡∏ó‡∏µ‡πà 2 (‡∏£‡πà‡∏≤‡∏¢‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß):</label>
                            <select id="pupil-2-spells" name="pupil-2-spells">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card-control">
                    <img src="https://hearthstone.wiki.gg/images/thumb/TOY_515.png/300px-TOY_515.png" alt="Sonya Waterdancer">
                    <label for="sonya">Sonya Waterdancer (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 1)</label>
                    <select id="sonya" name="sonya">
                        <option value="0">0 ‡πÉ‡∏ö</option>
                        <option value="1">1 ‡πÉ‡∏ö</option>
                    </select>
                    <p class="card-note">‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏Ñ‡∏ô‡∏µ‡πâ</p>
                </div>

                <div class="card-control">
                    <img src="https://hearthstone.wiki.gg/images/thumb/TOY_521t1.png/235px-TOY_521t1.png" alt="Sandbox Scoundrel">
                    <label for="scoundrel">Sandbox Scoundrel (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 2)</label>
                    <select id="scoundrel" name="scoundrel">
                        <option value="0">0 ‡πÉ‡∏ö</option>
                        <option value="1">1 ‡πÉ‡∏ö</option>
                        <option value="2">2 ‡πÉ‡∏ö</option>
                    </select>
                </div>

                <div class="card-control">
                    <img src="https://hearthstone.wiki.gg/images/thumb/BG31_BOB.png/300px-BG31_BOB.png" alt="Bob the Bartender">
                    <label for="bob">Bob the Bartender (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 1)</label>
                    <select id="bob" name="bob">
                        <option value="0">0 ‡πÉ‡∏ö</option>
                        <option value="1">1 ‡πÉ‡∏ö</option>
                    </select>
                </div>

                <div class="card-control">
                    <img src="https://hearthstone.wiki.gg/images/thumb/TIME_064.png/300px-TIME_064.png" alt="Chrono-Lord Deios">
                    <label for="deios">Chrono-Lord Deios (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 1)</label>
                    <select id="deios" name="deios">
                        <option value="0">0 ‡πÉ‡∏ö</option>
                        <option value="1">1 ‡πÉ‡∏ö</option>
                    </select>
                </div>

                <div class="card-control">
                    <img src="https://hearthstone.wiki.gg/images/thumb/VAC_321.png/300px-VAC_321.png" alt="Incindius">
                    <label for="incindius">Incindius (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 1)</label>
                    <select id="incindius" name="incindius">
                        <option value="0">0 ‡πÉ‡∏ö</option>
                        <option value="1">1 ‡πÉ‡∏ö</option>
                    </select>
                </div>
                
                <div class="card-control">
                    <img src="https://hearthstone.wiki.gg/images/thumb/EDR_979.png/300px-EDR_979.png?8fbc98" alt="Ancient of Yore">
                    <label for="ancientofyore">Ancient of Yore (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 2)</label>
                    <select id="ancientofyore" name="ancientofyore">
                        <option value="0">0 ‡πÉ‡∏ö</option>
                        <option value="1">1 ‡πÉ‡∏ö</option>
                        <option value="2">2 ‡πÉ‡∏ö</option>
                    </select>
                </div>
                
            </div>

            <div class="mana-setup">
                <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏≤‡∏ô‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</h2>
                <label for="start-mana">‡∏°‡∏≤‡∏ô‡∏≤ (1-10):</label>
                <input type="number" id="start-mana" name="start-mana" min="1" max="10" value="10">
            </div>

            <button type="button" id="start-button">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô</button>
            <button type="button" id="show-guide-button">‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</button>
        </form>
    </div>
    
    <div id="guide-container" class="container" style="display: none;">
        <h1>üìñ ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</h1>
        <div id="guide-steps">
            </div>
        <button type="button" id="back-to-setup-button">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
    </div>


    <div id="trainer-container" class="container" style="display: none;">
        <h1>‚öîÔ∏è ‡∏´‡∏ô‡πâ‡∏≤‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô‡∏Ñ‡∏≠‡∏°‡πÇ‡∏ö</h1>

        <div id="stats-bar">
            <div class="stat">
                <div class="stat-label">‡∏°‡∏≤‡∏ô‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                <div class="stat-value" id="mana-current">10</div>
            </div>
            <div class="stat">
                <div class="stat-label">Step ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô</div>
                <div class="stat-value" id="step-count">0</div>
            </div>
            <div class="stat">
                <div class="stat-label">Eruption ‡πÉ‡∏ô‡πÄ‡∏î‡∏Ñ</div>
                <div class="stat-value" id="eruption-count">0</div>
            </div>
            <div class="stat">
                <div class="stat-label">Eruption Damage</div>
                <div class="stat-value" id="eruption-damage">1</div>
            </div>
            <div class="stat" id="timer-stat">
                <div class="stat-label">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                <div class="stat-value" id="timer-display">75</div>
            </div>
        </div>

        <div id="prompt-message" style="display: none;"></div>

        <h2>‡∏™‡∏ô‡∏≤‡∏° (Minions) <span class="card-counter">(<span id="board-count">0</span>/7)</span></h2>
        <div id="board">
            </div>
        
        <div id="rope-container"></div>

        <h2>‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ö‡∏ô‡∏°‡∏∑‡∏≠ (Hand) <span class="card-counter">(<span id="hand-count">0</span>/10)</span></h2>
        <div id="hand">
            </div>

        <div class="trainer-buttons">
            <button id="undo-button" disabled>‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö (Undo)</button>
            <button id="end-turn-button">‡∏à‡∏ö‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô (‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô)</button>
        </div>
    </div>

    <div id="modal-overlay">
        <div id="modal-box">
            <h2 id="modal-title"></h2>
            <div id="modal-message"></div>
            <button id="modal-close-button">‡∏õ‡∏¥‡∏î</button>
            <button id="modal-restart-button" style="display: none;">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
        </div>
    </div>


    <script>
        // [*** ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πå‡∏î (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï) ***]
        const CARD_DB = {
            'shadowstep': { id: 'shadowstep', name: 'Shadowstep', baseCost: 0, type: 'Spell', img: 'https://hearthstone.wiki.gg/images/thumb/EX1_144.png/300px-EX1_144.png' },
            'tidepool': { id: 'tidepool', name: 'Tidepool Pupil', baseCost: 2, type: 'Minion', img: 'https://hearthstone.wiki.gg/images/thumb/VAC_304.png/300px-VAC_304.png' },
            'sonya': { id: 'sonya', name: 'Sonya Waterdancer', baseCost: 4, type: 'Minion', img: 'https://hearthstone.wiki.gg/images/thumb/TOY_515.png/300px-TOY_515.png' },
            'scoundrel': { id: 'scoundrel', name: 'Sandbox Scoundrel', baseCost: 1, type: 'Minion', img: 'https://hearthstone.wiki.gg/images/thumb/TOY_521t1.png/235px-TOY_521t1.png' },
            'bob': { id: 'bob', name: 'Bob the Bartender', baseCost: 6, type: 'Minion', img: 'https://hearthstone.wiki.gg/images/thumb/BG31_BOB.png/300px-BG31_BOB.png' },
            'deios': { id: 'deios', name: 'Chrono-Lord Deios', baseCost: 7, type: 'Minion', img: 'https://hearthstone.wiki.gg/images/thumb/TIME_064.png/300px-TIME_064.png' },
            'incindius': { id: 'incindius', name: 'Incindius', baseCost: 7, type: 'Minion', img: 'https://hearthstone.wiki.gg/images/thumb/VAC_321.png/300px-VAC_321.png' },
            'ancientofyore': { id: 'ancientofyore', name: 'Ancient of Yore', baseCost: 5, type: 'Minion', img: 'https://hearthstone.wiki.gg/images/thumb/EDR_979.png/300px-EDR_979.png?8fbc98' }, 
            
            'coin': { id: 'coin', name: 'The Coin', baseCost: 0, type: 'Spell', img: 'https://hearthstone.wiki.gg/images/thumb/GAME_005.png/300px-GAME_005.png' },
            'preparation': { id: 'preparation', name: 'Preparation', baseCost: 0, type: 'Spell', img: 'https://hearthstone.wiki.gg/images/thumb/EX1_145.png/300px-EX1_145.png' },
            'magmarager': { id: 'magmarager', name: 'Magma Rager', baseCost: 3, type: 'Minion', img: 'https://hearthstone.wiki.gg/images/thumb/CS2_118.png/300px-CS2_118.png' },
            'icerager': { id: 'icerager', name: 'Ice Rager', baseCost: 3, type: 'Minion', img: 'https://hearthstone.wiki.gg/images/thumb/AT_092.png/300px-AT_092.png' },
            'amgamrager': { id: 'amgamrager', name: 'Am\'gam Rager', baseCost: 3, type: 'Minion', img: 'https://hearthstone.wiki.gg/images/thumb/OG_248.png/300px-OG_248.png' },
            'thalnos': { id: 'thalnos', name: 'Bloodmage Thalnos', baseCost: 2, type: 'Minion', img: 'https://hearthstone.wiki.gg/images/thumb/EX1_012.png/300px-EX1_012.png' }
        };
        
        let modalOverlay, modalTitle, modalMessage, modalCloseButton, modalRestartButton;
        let promptMessageEl;
        
        let gameTimer = null;
        let timeLeft = 75;

        // --- ‡∏™‡πà‡∏ß‡∏ô JS ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤ Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            const tidepoolSelect = document.getElementById('tidepool');
            const pupilOptionsContainer = document.getElementById('pupil-options-container');
            const pupil1Options = document.getElementById('pupil-1-options');
            const pupil2Options = document.getElementById('pupil-2-options');
            const startButton = document.getElementById('start-button');
            const recommendButton = document.getElementById('recommend-button'); 
            
            // [*** ‡πÄ‡∏û‡∏¥‡πà‡∏°: container 3 ‡∏™‡πà‡∏ß‡∏ô ***]
            const setupContainer = document.getElementById('setup-container');
            const trainerContainer = document.getElementById('trainer-container');
            const guideContainer = document.getElementById('guide-container');
            
            // [*** ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏õ‡∏∏‡πà‡∏° Guide ***]
            const showGuideButton = document.getElementById('show-guide-button');
            const backToSetupButton = document.getElementById('back-to-setup-button');

            
            modalOverlay = document.getElementById('modal-overlay');
            modalTitle = document.getElementById('modal-title');
            modalMessage = document.getElementById('modal-message');
            modalCloseButton = document.getElementById('modal-close-button');
            modalRestartButton = document.getElementById('modal-restart-button');
            
            promptMessageEl = document.getElementById('prompt-message');

            // --- Modal Logic ---
            function showPopup(title, message, showRestart = false) {
                modalTitle.textContent = title;
                modalMessage.innerHTML = `<p>${message.replace(/\n/g, '<br>')}</p>`; 
                modalMessage.className = ''; 
                modalRestartButton.style.display = showRestart ? 'inline-block' : 'none';
                modalCloseButton.style.display = 'inline-block';
                modalOverlay.style.display = 'flex';
            }
            window.showPopup = showPopup; 

            function hidePopup() {
                modalOverlay.style.display = 'none';
                modalCloseButton.style.display = 'inline-block';
            }
            window.hidePopup = hidePopup; 

            modalCloseButton.addEventListener('click', hidePopup);
            modalRestartButton.addEventListener('click', () => {
                hidePopup();
                setupContainer.style.display = 'block';
                trainerContainer.style.display = 'none';
            });
            // --------------------

            // [*** ‡πÄ‡∏û‡∏¥‡πà‡∏°: Logic ‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ***]
            showGuideButton.addEventListener('click', () => {
                setupContainer.style.display = 'none';
                guideContainer.style.display = 'block';
            });
            backToSetupButton.addEventListener('click', () => {
                guideContainer.style.display = 'none';
                setupContainer.style.display = 'block';
            });
            
            // [*** ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ Guide ***]
            function populateGuide() {
                const guideStepsEl = document.getElementById('guide-steps');
                const steps = [
                    { step: 1, text: "‡πÄ‡∏•‡πà‡∏ô Sandbox Scoundrel", card: "scoundrel" },
                    { step: 2, text: "‡πÄ‡∏•‡πà‡∏ô Chrono-Lord Deios", card: "deios" },
                    { step: 3, text: "‡πÄ‡∏•‡πà‡∏ô Shadowstep ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å Sandbox Scoundrel", card: "shadowstep" },
                    { step: 4, text: "‡πÄ‡∏•‡πà‡∏ô Sandbox Scoundrel", card: "scoundrel" },
                    { step: 5, text: "‡πÄ‡∏•‡πà‡∏ô Incindius", card: "incindius" },
                    { step: 6, text: "‡πÄ‡∏•‡πà‡∏ô Tidepool Pupil ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Shadowstep ‡∏ó‡∏±‡πâ‡∏á 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á", card: "tidepool" },
                    { step: 7, text: "‡πÄ‡∏•‡πà‡∏ô Shadowstep ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å Tidepool Pupil", card: "shadowstep" },
                    { step: 8, text: "‡πÄ‡∏•‡πà‡∏ô Shadowstep ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å Sandbox Scoundrel", card: "shadowstep" },
                    { step: 9, text: "‡πÄ‡∏•‡πà‡∏ô Sandbox Scoundrel", card: "scoundrel" },
                    { step: 10, text: "‡πÄ‡∏•‡πà‡∏ô Bob the Bartender (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Refresh the Tavern 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)", card: "bob" },
                    { step: 11, text: "‡πÄ‡∏•‡πà‡∏ô Tidepool Pupil (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Shadowstep 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)", card: "tidepool" },
                    { step: 12, text: "‡πÄ‡∏•‡πà‡∏ô Shadowstep ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å Tidepool Pupil", card: "shadowstep" },
                    { step: 13, text: "‡πÄ‡∏•‡πà‡∏ô Shadowstep ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å Sandbox Scoundrel", card: "shadowstep" },
                    { step: 14, text: "‡πÄ‡∏•‡πà‡∏ô Tidepool Pupil (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Shadowstep 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)", card: "tidepool" },
                    { step: 15, text: "‡πÄ‡∏•‡πà‡∏ô Shadowstep ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å Tidepool Pupil", card: "shadowstep" },
                    { step: 16, text: "‡πÄ‡∏•‡πà‡∏ô Shadowstep ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å Incindius", card: "shadowstep" },
                    { step: 17, text: "‡πÄ‡∏•‡πà‡∏ô Tidepool Pupil (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Shadowstep 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)", card: "tidepool" },
                    { step: 18, text: "‡πÄ‡∏•‡πà‡∏ô Shadowstep ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å Tidepool Pupil", card: "shadowstep" },
                    { step: 19, text: "‡πÄ‡∏•‡πà‡∏ô Sandbox Scoundrel", card: "scoundrel" },
                    { step: 20, text: "‡πÄ‡∏•‡πà‡∏ô Incindius", card: "incindius" },
                    { step: 21, text: "‡πÄ‡∏•‡πà‡∏ô Shadowstep ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å Sandbox Scoundrel", card: "shadowstep" },
                    { step: 22, text: "‡πÄ‡∏•‡πà‡∏ô Tidepool Pupil (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Shadowstep 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)", card: "tidepool" },
                    { step: 23, text: "‡πÄ‡∏•‡πà‡∏ô Shadowstep ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å Tidepool Pupil", card: "shadowstep" },
                    { step: 24, text: "‡πÄ‡∏•‡πà‡∏ô Shadowstep ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å Incindius", card: "shadowstep" },
                    { step: 25, text: "‡πÄ‡∏•‡πà‡∏ô Tidepool Pupil (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Shadowstep 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)", card: "tidepool" },
                    { step: 26, text: "‡πÄ‡∏•‡πà‡∏ô Shadowstep ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å Tidepool Pupil", card: "shadowstep" },
                    { step: 27, text: "‡πÄ‡∏•‡πà‡∏ô Sandbox Scoundrel", card: "scoundrel" },
                    { step: 28, text: "‡πÄ‡∏•‡πà‡∏ô Incindius", card: "incindius" },
                    { step: 29, text: "‡πÄ‡∏•‡πà‡∏ô Shadowstep ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å Sandbox Scoundrel", card: "shadowstep" },
                    { step: 30, text: "‡πÄ‡∏•‡πà‡∏ô Tidepool Pupil (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Shadowstep 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)", card: "tidepool" },
                    { step: 31, text: "‡πÄ‡∏•‡πà‡∏ô Shadowstep ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å Tidepool Pupil", card: "shadowstep" },
                    { step: 32, text: "‡πÄ‡∏•‡πà‡∏ô Shadowstep ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å Incindius", card: "shadowstep" }
                ];

                let html = steps.map(item => {
                    const cardImg = CARD_DB[item.card] ? CARD_DB[item.card].img : '';
                    return `
                        <div class="guide-step">
                            <img src="${cardImg}" alt="${item.card}">
                            <div class="guide-step-text">
                                <strong>Step ${item.step}:</strong>
                                <span>${item.text}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                html += `<div class="guide-loop">... ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏ô Step 17 - Step 32 ‡πÑ‡∏õ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ ...</div>`;
                
                html += `
                    <div class="guide-step">
                        <img src="${CARD_DB['scoundrel'].img}" alt="scoundrel">
                        <div class="guide-step-text">
                            <strong>Step ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢:</strong>
                            <span>‡πÄ‡∏•‡πà‡∏ô Sandbox Scoundrel</span>
                        </div>
                    </div>
                `;
                html += `
                    <div class="guide-step">
                        <img src="${CARD_DB['ancientofyore'].img}" alt="ancientofyore">
                        <div class="guide-step-text">
                            <strong>Step ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢:</strong>
                            <span>‡πÄ‡∏•‡πà‡∏ô Ancient of Yore</span>
                        </div>
                    </div>
                `;

                guideStepsEl.innerHTML = html;
            }
            populateGuide(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
            
            // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô Guide ---


            tidepoolSelect.addEventListener('change', (e) => {
                const count = parseInt(e.target.value, 10);
                if (count === 0) {
                    pupilOptionsContainer.style.display = 'none';
                    pupil1Options.style.display = 'none';
                    pupil2Options.style.display = 'none';
                } else if (count === 1) {
                    pupilOptionsContainer.style.display = 'block';
                    pupil1Options.style.display = 'block';
                    pupil2Options.style.display = 'none';
                } else {
                    pupilOptionsContainer.style.display = 'block';
                    pupil1Options.style.display = 'block';
                    pupil2Options.style.display = 'block';
                }
            });

            recommendButton.addEventListener('click', () => {
                document.getElementById('shadowstep').value = '1';
                document.getElementById('tidepool').value = '2';
                tidepoolSelect.dispatchEvent(new Event('change')); 
                
                document.getElementById('pupil-1-spells').value = '2';
                document.getElementById('pupil-2-spells').value = '1';
                document.getElementById('sonya').value = '0';
                document.getElementById('scoundrel').value = '1';
                document.getElementById('bob').value = '1';
                document.getElementById('deios').value = '1';
                document.getElementById('incindius').value = '1';
                document.getElementById('ancientofyore').value = '1'; 
                document.getElementById('start-mana').value = '8';
            });

            startButton.addEventListener('click', () => {
                const initialHand = [];
                let totalCards = 0;
                
                const shadowstepCount = parseInt(document.getElementById('shadowstep').value, 10);
                totalCards += shadowstepCount;
                for (let i = 0; i < shadowstepCount; i++) {
                    initialHand.push({ ...CARD_DB.shadowstep, currentCost: 0, instanceId: `card_${Date.now()}_${i}` });
                }

                const tidepoolCount = parseInt(document.getElementById('tidepool').value, 10);
                totalCards += tidepoolCount;
                if (tidepoolCount >= 1) {
                    const spells1 = parseInt(document.getElementById('pupil-1-spells').value, 10);
                    initialHand.push({ ...CARD_DB.tidepool, currentCost: 2, spellsPlayed: spells1, instanceId: `card_${Date.now()}_ss1` });
                }
                if (tidepoolCount === 2) {
                    const spells2 = parseInt(document.getElementById('pupil-2-spells').value, 10);
                    initialHand.push({ ...CARD_DB.tidepool, currentCost: 2, spellsPlayed: spells2, instanceId: `card_${Date.now()}_ss2` });
                }

                const sonyaCount = parseInt(document.getElementById('sonya').value, 10);
                totalCards += sonyaCount;
                if (sonyaCount > 0) {
                    initialHand.push({ ...CARD_DB.sonya, currentCost: 4, instanceId: `card_${Date.now()}_s` });
                }

                const scoundrelCount = parseInt(document.getElementById('scoundrel').value, 10);
                totalCards += scoundrelCount;
                for (let i = 0; i < scoundrelCount; i++) {
                    initialHand.push({ ...CARD_DB.scoundrel, currentCost: 1, instanceId: `card_${Date.now()}_sc${i}` });
                }

                const bobCount = parseInt(document.getElementById('bob').value, 10);
                totalCards += bobCount;
                if (bobCount > 0) {
                    initialHand.push({ ...CARD_DB.bob, currentCost: 6, instanceId: `card_${Date.now()}_b` });
                }

                const deiosCount = parseInt(document.getElementById('deios').value, 10);
                totalCards += deiosCount;
                if (deiosCount > 0) {
                    initialHand.push({ ...CARD_DB.deios, currentCost: 7, instanceId: `card_${Date.now()}_d` });
                }

                const incindiusCount = parseInt(document.getElementById('incindius').value, 10);
                totalCards += incindiusCount;
                if (incindiusCount > 0) {
                    initialHand.push({ ...CARD_DB.incindius, currentCost: 7, instanceId: `card_${Date.now()}_i` });
                }

                const ancientofyoreCount = parseInt(document.getElementById('ancientofyore').value, 10);
                totalCards += ancientofyoreCount;
                for (let i = 0; i < ancientofyoreCount; i++) {
                    initialHand.push({ ...CARD_DB.ancientofyore, currentCost: 5, instanceId: `card_${Date.now()}_aoy${i}` });
                }

                if (totalCards > 10) {
                    showPopup('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡πÉ‡∏ö!'); 
                    return;
                }

                const startMana = parseInt(document.getElementById('start-mana').value, 10);

                const initialSetup = {
                    hand: initialHand,
                    mana: startMana,
                    mode: 'timed' 
                };

                setupContainer.style.display = 'none';
                trainerContainer.style.display = 'block';
                
                initializeTrainer(initialSetup);
            });
        });


        // --- ‡∏™‡πà‡∏ß‡∏ô JS ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤ Trainer ---

        let gameState = {};
        let gameStateHistory = []; 

        let manaCurrentEl, stepCountEl, eruptionCountEl, eruptionDamageEl, boardEl, handEl, endTurnButtonEl, undoButtonEl;
        let timerStatEl, timerDisplayEl, ropeEl; 
        let boardCountEl, handCountEl; 

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function showDiscoverPopup(title, cardIds, callback) {
            modalTitle.textContent = title;
            modalMessage.innerHTML = ''; 
            modalMessage.className = 'discover-grid'; 
            
            modalCloseButton.style.display = 'none';
            modalRestartButton.style.display = 'none';

            cardIds.forEach(cardId => {
                const card = CARD_DB[cardId];
                if (!card) {
                    console.error("Discover Error: Card ID not found", cardId);
                    return;
                }
                const img = document.createElement('img');
                img.src = card.img;
                img.alt = card.name;
                img.className = 'discover-option-card';
                
                img.addEventListener('click', () => {
                    hidePopup(); 
                    callback(cardId); 
                });
                
                modalMessage.appendChild(img);
            });
            
            modalOverlay.style.display = 'flex';
        }
        
        function showBobPopup(title, onChoose) {
            modalTitle.textContent = title;
            modalMessage.innerHTML = '';
            modalMessage.className = 'discover-grid'; 
            
            modalCloseButton.style.display = 'none';
            modalRestartButton.style.display = 'none';

            const options = [
                { id: 'freeze', name: 'Freeze the Shop', img: 'https://hearthstone.wiki.gg/images/thumb/BG31_BOBt.png/235px-BG31_BOBt.png' },
                { id: 'recruit', name: 'Recruit a Minion', img: 'https://hearthstone.wiki.gg/images/thumb/BG31_BOBt2.png/235px-BG31_BOBt2.png' },
                { id: 'refresh', name: 'Refresh the Tavern', img: 'https://hearthstone.wiki.gg/images/thumb/BG31_BOBt3.png/235px-BG31_BOBt3.png' },
                { id: 'triple', name: 'Find a Triple', img: 'https://hearthstone.wiki.gg/images/thumb/BG31_BOBt4.png/235px-BG31_BOBt4.png' }
            ];

            options.forEach(opt => {
                const div = document.createElement('div');
                div.className = 'bob-option';
                div.innerHTML = `
                    <img src="${opt.img}" alt="${opt.name}">
                    <p>${opt.name}</p>
                `;
                div.addEventListener('click', () => {
                    hidePopup();
                    onChoose(opt.id); 
                });
                modalMessage.appendChild(div);
            });
            
            modalOverlay.style.display = 'flex';
        }


        function updateTimer() {
            timeLeft--;
            timerDisplayEl.textContent = timeLeft;
            
            // [*** ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡πÅ‡∏™‡∏î‡∏á Rope ***]
            if (timeLeft === 20) {
                ropeEl.style.display = 'block';
                ropeEl.style.animation = 'burn-rope 20s linear forwards';
            }
            
            if (timeLeft <= 10) {
                timerDisplayEl.style.color = '#c0392b'; 
            }

            if (timeLeft <= 0) {
                clearInterval(gameTimer);
                if (!gameState.isGameOver) { 
                    showPopup('‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤!', '‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏°‡∏î! ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•', true);
                    handleEndTurn(); 
                }
            }
        }


        function initializeTrainer(setup) {
            manaCurrentEl = document.getElementById('mana-current');
            stepCountEl = document.getElementById('step-count');
            eruptionCountEl = document.getElementById('eruption-count');
            eruptionDamageEl = document.getElementById('eruption-damage');
            boardEl = document.getElementById('board');
            handEl = document.getElementById('hand');
            endTurnButtonEl = document.getElementById('end-turn-button');
            undoButtonEl = document.getElementById('undo-button'); 
            promptMessageEl = document.getElementById('prompt-message');
            timerStatEl = document.getElementById('timer-stat');
            timerDisplayEl = document.getElementById('timer-display');
            boardCountEl = document.getElementById('board-count'); 
            handCountEl = document.getElementById('hand-count'); 
            ropeEl = document.getElementById('rope-container'); // [*** ‡πÄ‡∏û‡∏¥‡πà‡∏°: Rope element ***]

            if (gameTimer) clearInterval(gameTimer);

            gameState = {
                mana: setup.mana,
                steps: 0,
                eruptionCount: 0,
                eruptionDamage: 1, 
                hand: setup.hand,
                board: [],
                scoundrelDiscount: 0,
                isTargeting: false,
                targetingCard: null,
                mode: setup.mode,
                isGameOver: false,
                summaryMessage: "" // [*** ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ ***]
            };
            
            gameStateHistory = [];

            endTurnButtonEl.removeEventListener('click', handleEndTurn);
            endTurnButtonEl.addEventListener('click', handleEndTurn);
            
            undoButtonEl.removeEventListener('click', handleUndo);
            undoButtonEl.addEventListener('click', handleUndo);

            // [*** ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï Rope ***]
            ropeEl.style.display = 'none';
            ropeEl.style.animation = 'none';

            timerStatEl.style.display = 'block';
            timeLeft = 75; 
            timerDisplayEl.textContent = timeLeft;
            timerDisplayEl.style.color = '#f0b90b'; 

            gameTimer = setInterval(updateTimer, 1000); 

            updateUI();
        }

        // --- UI Functions ---

        function updateUI() {
            manaCurrentEl.textContent = gameState.mana;
            stepCountEl.textContent = gameState.steps;
            eruptionCountEl.textContent = gameState.eruptionCount;
            eruptionDamageEl.textContent = gameState.eruptionCount === 0 ? 0 : gameState.eruptionDamage;

            boardCountEl.textContent = gameState.board.length;
            handCountEl.textContent = gameState.hand.length;

            boardEl.innerHTML = '';
            gameState.board.forEach(minion => {
                const minionDiv = document.createElement('div');
                minionDiv.className = 'minion-on-board';
                minionDiv.dataset.instanceId = minion.instanceId;
                minionDiv.innerHTML = `
                    <img src="${minion.img}" alt="${minion.name}">
                    <p>${minion.name}</p>
                `;
                
                minionDiv.addEventListener('click', () => handleMinionClick(minion));
                boardEl.appendChild(minionDiv);
            });

            handEl.innerHTML = '';
            gameState.hand.forEach(card => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card-in-hand';
                cardDiv.dataset.instanceId = card.instanceId;
                
                const displayCost = Math.max(0, card.currentCost - gameState.scoundrelDiscount);
                
                const isPlayable = checkPlayable(card, displayCost);
                if (!isPlayable) {
                    cardDiv.classList.add('unplayable');
                }

                const baseCost = CARD_DB[card.id].baseCost;
                let costColor = 'white';
                
                if (card.currentCost < baseCost) {
                    costColor = '#00ff00'; 
                } else if (card.currentCost > baseCost) {
                    costColor = '#ff0000'; 
                }
                
                if (displayCost < card.currentCost) {
                    costColor = '#00ff00';
                }

                let html = `
                    <img src="${card.img}" alt="${card.name}">
                    <div class="card-cost" style="color: ${costColor};">
                        ${displayCost}
                    </div>
                `;

                if (card.id === 'tidepool') {
                    html += `<div class="pupil-counter">Spells: ${card.spellsPlayed}</div>`;
                }

                cardDiv.innerHTML = html;
                
                if (isPlayable) {
                    cardDiv.addEventListener('click', () => playCard(card));
                }
                handEl.appendChild(cardDiv);
            });
            
            if (gameState.isTargeting) {
                promptMessageEl.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏¥‡∏ô‡πÄ‡∏ô‡∏µ‡πà‡∏¢‡∏ô‡∏ö‡∏ô‡∏™‡∏ô‡∏≤‡∏° 1 ‡∏ï‡∏±‡∏ß";
                promptMessageEl.style.display = 'block';
            } else {
                promptMessageEl.style.display = 'none';
            }

            undoButtonEl.disabled = gameStateHistory.length === 0 || gameState.isGameOver;
            updateTargetingUI();
            
            // [*** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏õ‡∏ó‡∏µ‡πà handleEndTurn ***]
            endTurnButtonEl.disabled = false;
        }

        function checkPlayable(card, displayCost) {
            if (gameState.isGameOver) return false; 
            if (gameState.isTargeting) return false; 
            if (displayCost > gameState.mana) return false; 

            if (card.type === 'Minion') {
                if (gameState.board.length >= 7) return false; 
            }

            if (card.id === 'shadowstep') {
                if (gameState.board.length === 0) return false; 
            }

            if (card.id === 'tidepool') {
                if (card.spellsPlayed < 3) return false; 
            }

            return true;
        }

        function updateTargetingUI() {
            document.querySelectorAll('.minion-on-board.targeting').forEach(el => el.classList.remove('targeting'));

            if (gameState.isTargeting && gameState.targetingCard.id === 'shadowstep') {
                document.querySelectorAll('.minion-on-board').forEach(el => {
                    const minionId = el.dataset.instanceId;
                    const minion = gameState.board.find(m => m.instanceId === minionId);
                    if (minion && minion.id !== 'ancientofyore') {
                         el.classList.add('targeting');
                    }
                });
            }
        }

        // --- Game Logic Functions ---

        function handleUndo() {
            if (gameStateHistory.length === 0 || gameState.isGameOver) return;
            gameState = gameStateHistory.pop();
            updateUI();
        }
        
        function addCardToHand(cardId, costOverride = null) {
            if (gameState.hand.length >= 10) return; 
            
            const baseCard = CARD_DB[cardId];
            if (!baseCard) {
                console.error("Card ID not found in DB:", cardId);
                return;
            }
            
            const newCard = {
                ...baseCard,
                currentCost: costOverride !== null ? costOverride : baseCard.baseCost,
                instanceId: `card_${Date.now()}_${Math.random()}`
            };
            
            if (newCard.id === 'tidepool') {
                newCard.spellsPlayed = 0;
                newCard.spellsHistory = [];
                newCard.wasBounced = false;
            }
            
            gameState.hand.push(newCard);
        }

        function playCard(card) {
            const displayCost = Math.max(0, card.currentCost - gameState.scoundrelDiscount);
            if (!checkPlayable(card, displayCost)) {
                console.warn("‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:", card);
                return;
            }
            
            gameStateHistory.push(JSON.parse(JSON.stringify(gameState)));

            const cost = displayCost;
            gameState.mana -= cost;
            gameState.steps++;
            
            if (gameState.scoundrelDiscount > 0 && card.id !== 'scoundrel') {
                 gameState.scoundrelDiscount = 0;
            }
            
            gameState.hand = gameState.hand.filter(c => c.instanceId !== card.instanceId);

            switch (card.id) {
                case 'shadowstep':
                    handleShadowstep(card);
                    triggerSpellPlayed(card);
                    break;
                case 'tidepool':
                    handleTidepool(card); 
                    break;
                case 'sonya':
                    handleSonya(card);
                    break;
                case 'scoundrel':
                    handleScoundrel(card);
                    break;
                case 'bob':
                    handleBob(card); 
                    break;
                case 'deios':
                    handleDeios(card);
                    break;
                case 'incindius':
                    handleIncindius(card);
                    break;
                case 'ancientofyore': 
                    handleAncientOfYore(card);
                    break;
                
                case 'coin':
                    handleCoin(card);
                    triggerSpellPlayed(card);
                    break;
                case 'preparation':
                    handlePreparation(card);
                    triggerSpellPlayed(card);
                    break;
                case 'thalnos':
                    handleThalnos(card);
                    break;
                case 'magmarager':
                    handleMagmaRager(card);
                    break;
                case 'icerager':
                    handleIceRager(card);
                    break;
                case 'amgamrager':
                    handleAmgamRager(card);
                    break;
            }

            if (card.type === 'Minion' && card.id !== 'tidepool' && card.id !== 'bob') {
                triggerMinionPlayed(card);
            }

            if (card.id !== 'tidepool' && card.id !== 'bob') {
                 updateUI();
            }
        }

        function triggerSpellPlayed(playedCard) {
            gameState.hand.forEach(card => {
                if (card.id === 'tidepool') {
                    card.spellsPlayed++;
                    if (!card.spellsHistory) card.spellsHistory = [];
                    if (card.spellsHistory.length < 3) {
                        card.spellsHistory.push(playedCard.id);
                    }
                }
            });
        }
        
        function triggerMinionPlayed(playedMinion) {
            const sonya = gameState.board.find(m => m.id === 'sonya');
            
            if (sonya && playedMinion.id !== 'sonya' && CARD_DB[playedMinion.id].baseCost === 1) {
                addCardToHand(playedMinion.id, 0);
            }
        }

        function isDeiosOnBoard() {
            return gameState.board.some(minion => minion.id === 'deios');
        }

        function isAncientOnBoard() {
            return gameState.board.some(minion => minion.id === 'ancientofyore');
        }

        // --- Card Handlers ---

        function handleShadowstep(card) {
            gameState.isTargeting = true;
            gameState.targetingCard = card;
        }

        function handleMinionClick(minion) {
            if (!gameState.isTargeting) return;

            if (gameState.targetingCard.id === 'shadowstep') {
                
                if (minion.id === 'ancientofyore') {
                    return; 
                }

                gameStateHistory.push(JSON.parse(JSON.stringify(gameState)));

                gameState.board = gameState.board.filter(m => m.instanceId !== minion.instanceId);

                if (gameState.hand.length < 10) {
                    const bouncedCardInfo = CARD_DB[minion.id]; 
                    const bouncedCard = { ...bouncedCardInfo }; 
                    
                    bouncedCard.currentCost = Math.max(0, bouncedCardInfo.baseCost - 2); 
                    bouncedCard.instanceId = minion.instanceId; 
                    
                    if (bouncedCard.id === 'tidepool') {
                        bouncedCard.spellsPlayed = 0;
                        bouncedCard.spellsHistory = [];
                        bouncedCard.wasBounced = true; 
                    }
                    
                    gameState.hand.push(bouncedCard);
                }

                gameState.isTargeting = false;
                gameState.targetingCard = null;
                updateUI();
            }
        }

        function handleTidepool(card) {
            gameState.board.push(card);
            triggerMinionPlayed(card); 
            updateUI(); 

            const deios = isDeiosOnBoard();
            
            let options;
            if (card.wasBounced && card.spellsHistory && card.spellsHistory.length === 3) {
                options = card.spellsHistory;
            } else {
                options = ['shadowstep', 'coin', 'preparation'];
            }

            // Callback 1
            const discoverCallback1 = (chosenCardId1) => {
                addCardToHand(chosenCardId1); 
                
                if (deios) {
                    showDiscoverPopup('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ö‡∏ó‡∏µ‡πà 2 (Deios)', shuffle([...options]), discoverCallback2);
                } else {
                    updateUI(); 
                }
            };
            
            // Callback 2 (for Deios)
            const discoverCallback2 = (chosenCardId2) => {
                addCardToHand(chosenCardId2); 
                updateUI(); 
            };
            
            showDiscoverPopup('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ö‡∏ó‡∏µ‡πà 1', shuffle([...options]), discoverCallback1);
        }

        function handleSonya(card) {
            gameState.board.push(card);
            triggerMinionPlayed(card);
        }

        function handleScoundrel(card) {
            gameState.board.push(card);
            gameState.scoundrelDiscount = isDeiosOnBoard() ? 6 : 3;
            triggerMinionPlayed(card);
        }

        function handleBob(card) {
            gameState.board.push(card);
            triggerMinionPlayed(card);
            updateUI(); 

            const deios = isDeiosOnBoard();

            const handleBobChoice = (choiceId, isDeiosRound) => {
                let isAsync = false; 
                
                switch (choiceId) {
                    case 'freeze':
                        break; 
                    case 'recruit':
                        addCardToHand('magmarager');
                        break;
                    case 'refresh':
                        isAsync = true;
                        const ragerOptions = ['magmarager', 'icerager', 'amgamrager'];
                        showDiscoverPopup('Refresh the Tavern', ragerOptions, (chosenRager) => {
                            addCardToHand(chosenRager);
                            gameState.mana = Math.min(10, gameState.mana + 3);
                            
                            if (deios && !isDeiosRound) {
                                showBobPopup('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏µ‡∏Å 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á (Deios)', (choice2) => handleBobChoice(choice2, true));
                            } else {
                                updateUI(); 
                            }
                        });
                        break;
                    case 'triple':
                        addCardToHand('thalnos');
                        addCardToHand('thalnos');
                        addCardToHand('thalnos');
                        break;
                }
                
                if (!isAsync) {
                    if (deios && !isDeiosRound) {
                        showBobPopup('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏µ‡∏Å 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á (Deios)', (choice2) => handleBobChoice(choice2, true));
                    } else {
                        updateUI();
                    }
                }
            };

            showBobPopup('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á', (choice1) => handleBobChoice(choice1, false));
        }

        function handleDeios(card) {
            gameState.board.push(card);
            triggerMinionPlayed(card);
        }

        function handleIncindius(card) {
            gameState.board.push(card);
            const amount = isDeiosOnBoard() ? 10 : 5;
            gameState.eruptionCount += amount;
            triggerMinionPlayed(card);
        }
        
        function handleAncientOfYore(card) {
            gameState.board.push(card);
            triggerMinionPlayed(card);
        }
        
        // --- Handlers ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏´‡∏°‡πà ---
        function handleCoin(card) {
            gameState.mana = Math.min(10, gameState.mana + 1);
        }

        function handlePreparation(card) {
            // (TriggerSpell ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô playCard)
        }

        function handleThalnos(card) {
            gameState.board.push(card);
            triggerMinionPlayed(card);
        }

        function handleMagmaRager(card) {
            gameState.board.push(card);
            triggerMinionPlayed(card);
        }

        function handleIceRager(card) {
            gameState.board.push(card);
            triggerMinionPlayed(card);
        }

        function handleAmgamRager(card) {
            gameState.board.push(card);
            triggerMinionPlayed(card);
        }


        function handleEndTurn() {
            // [*** BUG FIX ***]
            if (gameState.isGameOver) {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á popup ‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πâ‡∏≥
                showPopup('‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô', gameState.summaryMessage, true);
                return; 
            }
            gameState.isGameOver = true;
            
            if (gameTimer) clearInterval(gameTimer);

            // [*** ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ã‡πà‡∏≠‡∏ô Rope ‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏° ***]
            ropeEl.style.display = 'none';
            ropeEl.style.animation = 'none';
            endTurnButtonEl.disabled = true;
            undoButtonEl.disabled = true;


            const damageIncrease = isDeiosOnBoard() ? 2 : 1;
            gameState.eruptionDamage += damageIncrease;
            
            const totalDamage = gameState.eruptionCount * gameState.eruptionDamage;

            const ancientOnBoard = isAncientOnBoard();
            const damageTimingMessage = ancientOnBoard ?
                "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ô‡∏µ‡πâ" :
                "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ";
                
            let adviceMessage = "";
            if (!ancientOnBoard) {
                adviceMessage = "\n\n(‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏ß‡∏£‡∏•‡∏á Ancient of Yore ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏≤‡πÄ‡∏°‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡∏±‡πâ‡∏ô‡πÄ‡∏•‡∏¢‡πÉ‡∏ô‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ô‡∏µ‡πâ)";
            }

            const messageString = `
Steps ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô: ${gameState.steps}
Eruptions ‡πÉ‡∏ô‡πÄ‡∏î‡∏Ñ: ${gameState.eruptionCount}
Eruption Damage ‡∏ï‡πà‡∏≠‡πÉ‡∏ö (‡∏ì ‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô): ${gameState.eruptionDamage}
-------------------------
${damageTimingMessage}: ${totalDamage}${adviceMessage}
            `;
            
            // [*** ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ ***]
            gameState.summaryMessage = messageString;

            showPopup('‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô', messageString, true);
            
            // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å updateUI() ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
        }

    </script>
</body>
</html>
